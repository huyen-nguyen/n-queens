<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
	<meta name="generator" content="Jekyll v4.1.1">
	<link rel="shortcut icon" href="images/Gaming-Queen.ico"/>
	<script src="lib/d3.v4.min.js"></script>

	<title>N-queens SAT</title>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>

	<!-- Bootstrap core CSS -->
	<link rel="stylesheet" href="css/bootstrap.min.css"
		  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

	<!-- Custom styles for this template -->
	<link href="styles.css" rel="stylesheet">
</head>
<body class="py-4">
<script src="js/solver.js"></script>

<div class="container">

	<h1>N-queens Problem SAT Solver</h1>
	<p class="lead">Simple SAT solver for the <a href="https://developers.google.com/optimization/cp/queens"
												 target="_blank"
	>n-queens problem</a>. Just in put the number of queens.</p>

		<p class="mb-4">&nbsp;</p>

	<div class="row mb-3">
		<div class="col-md-8">
			<div>
				<div class="form-group mb-2" style="display: inline-block">
					<label>Number of Queens</label>
				</div>
				<div id="selectPanelDiv" class="form-group mx-sm-3 mb-2" style="display: inline-block">
				</div>
				<button id="runbutton" class="btn btn-success mb-2">Run</button>
				<div id="result" class="btn">
						<div class="loadingio-spinner-spinner-e4l0gr1tas4"><div class="ldio-6rtrst5re4l">
							<div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
						</div></div>
					</div>
			</div>
		</div>

	</div>
	<div class="row mb-3 wrapper container">
		<div id="cnf-wrapper" class="col-md-4 themed-grid-col bg-light">
			<div>
				<h4><code>CNF Formula in DIMACS</code></h4>
			</div>
			<div id="editor-wrapper" style="overflow: scroll !important;">
				<div id="editor"></div>
			</div>
		</div>
		<div class="col-md-8 themed-grid-col bg-light">
			<div>
				<h4><code>Output</code></h4>
			</div>
			<div id="output-wrapper" style="overflow: auto">
				<div class="row">
					<div id="output" class="col-md-12 bg-light" readOnly="true" spellcheck="false">
					</div>

				</div>
			</div>

			<div id="chess-wrapper" class="col-md-12 bg-light" style="overflow: auto">
				<div>
					<div id="chessBoardNormal" class="chessBoard mt-3" style="visibility: hidden">
					</div>
				</div>
			</div>
		</div>
	</div>

</div>
<script src="js/interface.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>

<!-- FontAwesome -->
<script src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

<script src="minisat/cryptominisat5_simple.js" type="text/javascript" charset="utf-8"></script>
<script>
	let outputString = ""
	function scroll() {
		document.getElementById("output").scrollTop = document.getElementById("output").scrollHeight;
	}

	function at_bottom() {
		var height = document.getElementById("output").offsetHeight;
		return (document.getElementById("output").scrollTop + height) >= document.getElementById("output").scrollHeight;
	}

	Module['onRuntimeInitialized'] = function () {
		$().ready(function () {
			$('#runbutton').removeAttr("disabled")
			$('#result').text('Ready');
		})
	}
	Module['print'] = function (text) {
		var bottom = at_bottom();
		$('#output').append("<code>" + text + "</code><br/>")
		outputString = outputString + ("|" + text)
		if (bottom) {
			scroll();
		}
	};
	Module['printErr'] = function (text) {
		$('#output').append("<code>--error-- " + text + "</code><br/>")
		// outputString = outputString + ("--error-- " + text + "\n")
		scroll();
	};


	must_stop = false;
	running = false;

	function check_result(result) {

		if (must_stop) {
			$('#output').append("<code>Stopped.<code><br/>")
			$('#result').text('Ready');
			$('#playbut').removeClass("fa-stop");
			$('#playbut').addClass("fa-play");

			scroll();
			must_stop = false;
			running = false;
			return;
		}

		var nconfl = num_conflicts();
		$('#result').text(nconfl + " confl");
		if (result == 0) {
			$('#result').html('<b>SATISFIABLE</b>');
			colorNormal(parseInt(document.getElementById("inputNumber").value), true)
			running = false;
		} else if (result == 1) {
			$('#result').html('<b>UNSATISFIABLE</b>');
			colorNormal(parseInt(document.getElementById("inputNumber").value), false)
			running = false;
		} else if (result == 2) {
			window.setTimeout(function () {
				var result = cont_query();
				check_result(result);
			}, 50);
		}

		if (!running) {
			$('#playbut').removeClass("fa-stop");
			$('#playbut').addClass("fa-play");
		}
	}

	$().ready(function () {
		$('#runbutton').click(function () {
			outputString = ""
			if (running) {
				must_stop = true;
				$('#output').append("<code>Stopping...</code><br/>")
				// outputString = outputString + ("Stopping...\n")
				scroll();
				return;
			}
			let val = parseInt(document.getElementById("inputNumber").value)
			if (!isValid(val)) {
				$('#editor').html("<code style='color: #a00000'>invalid input!</code>")
				$('#output').html("")
				$('#chessBoardNormal').html("")
				return
			}
			$("#editor").html(formatCNF(SAT_expression(val)))
			running = true;
			$('#playbut').removeClass("fa-play");
			$('#playbut').addClass("fa-stop");

			$('#result').text('Running');

			var source = SAT_expression(val);
			try {
				var result = cms_query(source)
				check_result(result);
			} catch (err) {
				console.log(result);
				console.log(err);
				running = false;
				must_stop = false;
				$('#result').text('Error');
			}
		})
	})

</script>

<script>
	function cms_query(source) {
		$('#output').html("");
		scroll();
		var solve_function = Module.cwrap('cstart_solve', 'number', ['string']);
		ret = solve_function(source);
		return ret;
	}

	function cont_query() {
		var cont_function = Module.cwrap('ccontinue_solve', 'number');
		ret = cont_function();
		return ret;
	}

	function num_conflicts() {
		var num_conflicts_function = Module.cwrap('cget_num_conflicts', 'number');
		ret = num_conflicts_function();
		return ret;
	}
</script>


</body>
</html>
